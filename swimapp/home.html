<!--
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-   Author : Wang Zi Xiang                   +- 
+-   Unit   : Nccu cs 						  +- 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- 
-->
<!DOCTYPE html>
<html lang="en">
<head>
	
	<meta charset="UTF-8">
	<title>Nccu cs Wang test system</title>
	<link rel="stylesheet" href="css/all.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="//d3js.org/d3.v3.min.js"></script>
	<script src="js/DomElements.js"></script>
	<script>
		let href,paremeter,token,data;
		let groupSet = new Set();
		let countSettingGroup=0;
		let ReqJoinSet=new Set();
		let ReqCancelSet=new Set();
		let ReqT_num;
		try{
			href=location.href;
			paremeter=href.split('?');
			token=paremeter[1].split("=");
			data={};
			data.token=token[1];
			$.ajax({
				url:"model/check.php",
				type:"POST",
				data:data,
				success: function(result){
					// console.log(result);
					if (result.trim()=="false") {
						document.location.href="index.html";
					}
				}
			});
		}catch(e){
			document.location.href="index.html";
		}
		
	</script>
</head>
</head>
<body>
	
	<div class="content">
		<button class="clock">clock</button>
		<button class="follow">Subscribe</button>
		<button class="logout">log out</button>
		<button class="setting_wrokshop">Set Workshop</button>
		<button class="setting_group">Set group</button>
		<button class="btn_joinGroup">Join group</button>
		<div class="group">
			<div class="group_list">
				
			</div>
			<div class="increse_g">
				<p>List Group name</p><br><input type="text" class="group_name"><br>
				<p>list Group Info.</p><br><textarea class="group_info" id="" cols="30" rows="10"></textarea><br>
				<font color="orange"><p id="group_result"></p><br></font>
				<button class="ins_btn">Increase group</button>

			</div>
		</div>
		<div class="joinGroup"></div>
		<div class="picGroup"></div>
		<div class="adjustGroup">
			<ul id="unconfirm" class="unconfirm"></ul>
			<ul id="alreadyC" class="alreadyC"></ul><br>
			<button class="sentReq">Send Request</button>
		</div>
		
	</div>
</body>
<script>
	function reqJoin(token,T_num){
		// console.log("reqJoin= "+T_num);
		let result = confirm("確定要申請加入群組？");
		let obj={};
		obj.token=token;
		obj.T_num=T_num;
		if(result==true){
			$.ajax({
				url:'model/reqJoin.php',
				method: 'POST',
				data:obj,
				cache: false,
				success: function(result){
					// console.log(result);
				}
			});
			alert("完成申請");
		}
	}
	function proposeReq(T_num,U_num){
		ReqJoinSet.add(U_num);
		ReqT_num=T_num;
	}
	function proposeDonereq(T_num,U_num){
		ReqCancelSet.add(U_num);
		// console.log("proposeDonereq"+U_num);
		ReqT_num=T_num;
	}
	function showReq(token,T_num) {
		let obj={};
		obj.token=token;
		obj.T_num=T_num;
		$.ajax({
				url:'model/reqDisplay.php',
				method: 'GET',
				data:obj,
				cache: false,
				success: function(result){
					console.log("result+"+result);
					let data=JSON.parse(result);
					let strReq="";
					let ReqDone="";
					if(result!=false){
						// $('.unconfirm').val("");
						// $('.alreadyC').val("");  
						document.getElementById("unconfirm").innerHTML = " ";
						document.getElementById("alreadyC").innerHTML = " ";

						for (let i = 0; i < data.Req.length; i++) {
							strReq+=add_button(" ","Reqbtn",data.Req[i].U_name,"proposeReq("+T_num+","+data.Req[i].U_num+")")+"<br>";
							// console.log(strReq);
						}
						for ( i = 0; i < data.ReqDone.length; i++) {
							ReqDone+=add_button(" ","ReqDonebtn",data.ReqDone[i].U_name,"proposeDonereq("+T_num+","+data.ReqDone[i].U_num+")" )+"<br>";

						}
							$('#unconfirm').append(strReq);
							$('#alreadyC').append(ReqDone);
					}
				}
	});
		
		
	}
	$('.clock').click(function(){
		document.location.href="clock.html?token="+token[1];
	});
	$('.follow').click(function(){
		document.location.href="follow.html?token="+token[1];
	});

	$('.logout').click(function(){
		$.ajax({
			url:'model/logout.php',
			async:false,
			success: function(result){
				// console.log(result);
				document.location.href="index.html";
			}
		});
	});

	$('.setting_group').click(function(){
		let groupContent="";
		countSettingGroup++;
		if((countSettingGroup%2)==1){
			$('.picGroup').css({'display':'block'});
			$('.group').css({
				"display":"block"	
			});
		}else{
			$('.picGroup').css({'display':'none'});
			$('.group').css({
				"display":"none"	
			});
		}
		$.ajax({
			url:"model/list_group.php?token="+token[1],
			method: 'GET',
			cache: false,
			success:function(data_o){
                	// data_o=JSON.stringify(data_o);
                	let treeData;
                	if(data!=false){
                		$('svg').css({'display':'none'});
                		let data=JSON.parse(data_o);

                		var width = 960,
                		height = 500,
                		root;

                		var force = d3.layout.force()
                		.linkDistance(80)
                		.charge(-120)
                		.gravity(.05)
                		.size([width, height])
                		.on("tick", tick);

                		var svg = d3.select(".picGroup").append("svg")
                		.attr("width", width)
                		.attr("height", height);

                		var link = svg.selectAll(".link"),
                		node = svg.selectAll(".node");

                		d3.json("json/"+token[1]+'.json', function(error, json) {
                			if (error) throw error;

                			root = json;
                			treeData=json;
                			console.log("~~~~"+JSON.stringify(json));
                			update();
                		});

                		function update() {
                			var nodes = flatten(root),
                			links = d3.layout.tree().links(nodes);
							  force
							  .nodes(nodes)
							  .links(links)
							  .start();

							  // Update links.
							  link = link.data(links, function(d) { return d.target.id; });

							  link.exit().remove();

							  link.enter().insert("line", ".node")
							  .attr("class", "link");

							  // Update nodes.
							  node = node.data(nodes, function(d) { return d.id; });

							  node.exit().remove();

							  var nodeEnter = node.enter().append("g")
							  .attr("class", "node")
							  .on("click", click)
							  .call(force.drag);

							  nodeEnter.append("circle")
							  .attr("r", function(d) { return Math.sqrt(d.size) / 5 || 4.5; });

							  nodeEnter.append("text")
							  .attr("dy", ".35em")
							  .text(function(d) { return d.name; });

							  node.select("circle")
							  .style("fill", color);
							}

							function tick() {
								link.attr("x1", function(d) { return d.source.x; })
								.attr("y1", function(d) { return d.source.y; })
								.attr("x2", function(d) { return d.target.x; })
								.attr("y2", function(d) { return d.target.y; });

								node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
							}

							function color(d) {
							  return d._children ? "#3182bd" // collapsed package
							      : d.children ? "#c6dbef" // expanded package
							      : "#fd8d3c"; // leaf node
							  }

// Toggle children on click.
							function click(d) {
								console.log("click="+JSON.stringify(treeData));
								// console.log(tree.children.length);
								let target=JSON.parse(JSON.stringify(d));
								let tree=JSON.parse(JSON.stringify(treeData));
								// console.log("eeee "+tree.children[0].name);

								try{
									for (let i =0; i<tree.children.length ; i++) {
										if(tree.children[i].name == target.name){
											// console.log("T_num= "+ tree.children[i].T_num);
											showReq(token[1],tree.children[i].T_num);
									}
								}
								}catch(e){

								}
								
							  if (d3.event.defaultPrevented) return; // ignore drag
							  if (d.children) {
							  	d._children = d.children;
							  	d.children = null;
							  } else {
							  	d.children = d._children;
							  	d._children = null;
							  }
							  update();
							}

// Returns a list of all nodes under the root.
							function flatten(root) {
								var nodes = [], i = 0;

								function recurse(node) {
									if (node.children) node.children.forEach(recurse);
									if (!node.id) node.id = ++i;
									nodes.push(node);
								}

								recurse(root);
								return nodes;
							}
					for (let i =0 ; i<data.group.length; i++) {
						if(groupSet.has(data.group[i].T_num)==false){
							groupContent+=add_button("","groupList",data.group[i].T_name,"showReq("+token[1]+","+data.group[i].T_num+")");
							// console.log("groupContent="+groupContent);
							groupSet.add(data.group[i].T_num);
						}	
					}
					$('.group_list').append(groupContent);
				}
			}
		});
	});
	$(".ins_btn").off().on('click',function(){
		let result = confirm("確定要新增群組？");
		let txt = "";
		if(result == true){
			let obj={};
			obj.token=token[1];
			obj.group_name=$('.group_name').val();
			obj.group_info=$('.group_info').val();
			$.ajax({
				url:"model/ins_grp.php",
				method: 'GET',
				data:obj,
				cache: false,
				success:function(data_o){
					if(data_o = true){
						alert("新增成功");
						obj.admin="admin:admin";
						$.ajax({
							url:'model/reqJoin.php',
							method: 'POST',
							data:obj,
							cache: false,
							success: function(result){
								// console.log(result);
							}
						});
					}else{
						alert("新增失敗");
					}
				}
			});
			txt = "確定新增";

		}else{
			txt = "取消新增";
		}
			// $(".group_result").val(txt);
			document.getElementById("group_result").innerHTML = txt;
			// location.reload();
		});
	var temp = '';
	$('.btn_joinGroup').click(function(){
		let groupContent="";
		let obj={};
		obj.token=token[1];
		obj.T_name="";
		$.ajax({
			url:"model/listAllgroup.php",
			method: 'GET',
			data:obj,
			cache: false,
			success:function(data_o){
				// console.log("joinGroup"+data_o);
				if(data!=false){
					temp = data_o;
					let data=JSON.parse(data_o);
					// console.log("looooooooog:   " + data);
					for (let i =0 ; i<data.group.length; i++) {
						if(groupSet.has(data.group[i].T_num)==false){
							groupContent+=add_button("","groupListofJoin",data.group[i].T_name,"reqJoin('"+token[1]+"',"+data.group[i].T_num+")");
							// console.log("groupContent="+groupContent);
							groupSet.add(data.group[i].T_num);
						}	
					}
					$('.joinGroup').append(groupContent);
				}
			}
		});
	});

	$('.sentReq').off().on('click',function(){
		console.log("work");
		console.log(ReqCancelSet);
		if(ReqJoinSet.size >0 || ReqCancelSet.size >0){
			let obj={};
			obj.T_num=ReqT_num;

			if(ReqJoinSet.size==1)
				obj.reqJoin=ReqJoinSet.values().next().value
			else
				obj.reqJoin=Array.from(ReqJoinSet);


			if(ReqCancelSet.size==1)
				obj.ReqCancelSet=ReqCancelSet.values().next().value
			else
				obj.ReqCancelSet=Array.from(ReqCancelSet);



			console.log("obj= "+JSON.stringify(obj));
			$.ajax({
				url:"model/adjustMember.php",
				method:"GET",
				data:obj,
				cache: false,
				success:function(result){
					console.log("res= "+result);
				}
			});
		}

	});
</script>
</html>
