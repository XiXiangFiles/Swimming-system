<!--
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
+-   Author : Wang Zi Xiang                   +- 
+-   Unit   : Nccu cs 						  +- 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- 
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Nccu cs Wang test system</title>
	<link rel="stylesheet" href="css/all.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="js/DomElements.js"></script>
	<script>
		let href,paremeter,token,data;
		try{
			href=location.href;
			paremeter=href.split('?');
			token=paremeter[1].split("=");
			data={};
			data.token=token[1];
			$.ajax({
				url:"model/check.php",
				type:"POST",
				data:data,
				success: function(result){
					console.log(result);
					if (result.trim()=="false") {
						document.location.href="index.html";
					}
				}
			});
		}catch(e){
			document.location.href="index.html";
		}
		
	</script>
</head>
</head>
<body>
	
	<div class="content">
		<button class="clock">clock</button>
		<button class="follow">Subscribe</button>
		<button class="logout">log out</button>
		<button class="setting_wrokshop">Set Workshop</button>
		<button class="setting_group">Set group</button>
		<button class="btn_joinGroup">Join group</button>
		<div class="group">
			<div class="group_list">
				
			</div>
			<div class="increse_g">
				<p>List Group name</p><br><input type="text" class="group_name"><br>
				<p>list Group Info.</p><br><textarea class="group_info" id="" cols="30" rows="10"></textarea><br>
				<font color="orange"><p id="group_result"></p><br></font>
						<button class="ins_btn">Increase group</button>

			</div>
		</div>
		<div class="joinGroup"></div>
	</div>
</body>
<script>
	function reqJoin(token,T_num){
		console.log("reqJoin= "+T_num);
		let result = confirm("確定要申請加入群組？");
		let obj={};
		obj.token=token;
		obj.T_num=T_num;
		if(result==true){
			$.ajax({
				url:'model/reqJoin.php',
                	method: 'POST',
                	data:obj,
                	cache: false,
				success: function(result){
					console.log(result);
				}
			});
			alert("完成申請");
		}
	}
	function showReq(token,T_num) {
		
		
		
	}
	let groupSet = new Set();
	let countSettingGroup=0;
	$('.clock').click(function(){
		document.location.href="clock.html?token="+token[1];
	});
	$('.follow').click(function(){
		document.location.href="follow.html?token="+token[1];
	});

	$('.logout').click(function(){
		$.ajax({
			url:'model/logout.php',
			async:false,
			success: function(result){
				console.log(result);
				document.location.href="index.html";
			}
		});
	});
	$('.setting_group').click(function(){
		let groupContent="";
		countSettingGroup++;
		if((countSettingGroup%2)==1){
			$('.group').css({
				"display":"block"	
			});
		}else{
			$('.group').css({
				"display":"none"	
			});
		}
		$.ajax({
                url:"model/list_group.php?token="+token[1],
                method: 'GET',
                cache: false,
                success:function(data_o){
                	// data_o=JSON.stringify(data_o);
                	if(data!=false){
                		let data=JSON.parse(data_o);
	                	for (let i =0 ; i<data.group.length; i++) {
		                		if(groupSet.has(data.group[i].T_num)==false){
			                		groupContent+=add_button("","groupList",data.group[i].T_name,"showReq("+token[1]+","+data.group[i].T_num+")");
			                		console.log("groupContent="+groupContent);
			                		groupSet.add(data.group[i].T_num);
	                		}	
	                	}
	                	$('.group_list').append(groupContent);
                	}
                }
        });
	});
	$(".ins_btn").off().on('click',function(){
			let result = confirm("確定要新增群組？");
			let txt = "";
			if(result == true){
				let obj={};
				obj.token=token[1];
				obj.group_name=$('.group_name').val();
				obj.group_info=$('.group_info').val();
				$.ajax({
                	url:"model/ins_grp.php",
                	method: 'GET',
                	data:obj,
                	cache: false,
                	success:function(data_o){
                		console.log(data_o);
                		if(data_o = true){
                			alert("新增成功");
                			obj.admin="admin:admin";
							$.ajax({
							url:'model/reqJoin.php',
			                	method: 'POST',
			                	data:obj,
			                	cache: false,
								success: function(result){
									console.log(result);
								}
							});
                		}else{
                			alert("新增失敗");
                		}
                	}
        		});
        		txt = "確定新增";

			}else{
				txt = "取消新增";
			}
			// $(".group_result").val(txt);
			// document.getElementById("group_result").innerHTML = txt;
			location.reload();
    });
    $('.btn_joinGroup').click(function(){
    	let groupContent="";
    	let obj={};
    	obj.token=token[1];
    	obj.T_name="";
    	$.ajax({
                	url:"model/listAllgroup.php",
                	method: 'GET',
                	data:obj,
                	cache: false,
                	success:function(data_o){
                		console.log("joinGroup"+data_o);
                		if(data!=false){
	                		let data=JSON.parse(data_o);
		                	for (let i =0 ; i<data.group.length; i++) {
			                		if(groupSet.has(data.group[i].T_num)==false){
				                		groupContent+=add_button("","groupListofJoin",data.group[i].T_name,"reqJoin("+token[1]+","+data.group[i].T_num+")");
				                		console.log("groupContent="+groupContent);
				                		groupSet.add(data.group[i].T_num);
		                		}	
		                	}
		                	$('.joinGroup').append(groupContent);
                		}
                	}
        		});
    });
</script>
</html>